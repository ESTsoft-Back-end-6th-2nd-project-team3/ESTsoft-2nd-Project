<!DOCTYPE html>
<html lang="ko-KR" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>내 목표 수정</title>
    <link href="/css/reset.css" rel="stylesheet">
    <link href="/css/base.css" rel="stylesheet">
</head>
<body>
<article id="edit-objective" class="container">
    <div class="objective-title">내 목표</div>
    <div class="objective-content">
        <div class="label-header">
            <div class="label">목표 설정</div>
            <button class="add-button button" onclick="addObjective()">추가</button>
            <span class="label label-date">날짜</span>
            <span class="label">달성 완료 체크</span>
        </div>
        <div class="objective-list">
            <!-- 목표 리스트를 Thymeleaf로 렌더링 -->
            <div th:each="objective : ${objectives}" class="objective-item">
                <input type="hidden" th:value="${objective.id}" class="objective-id">
                <input type="text" th:value="${objective.content}" class="objective-input box" placeholder="목표를 입력하세요">
                <input type="month" th:value="${#dates.format(objective.objectiveYearMonth, 'yyyy-MM')}" class="date-input box">
                <input type="checkbox" th:checked="${objective.isCompleted}" class="checkbox">
                <button class="delete-button button box" onclick="deleteObjective(this)">삭제</button>
            </div>
        </div>
        <div class="action-buttons">
            <button class="button" onclick="saveObjectives()">저장</button>
            <button class="button" onclick="cancelEdit()">취소</button>
        </div>
    </div>
</article>
<script>
    // 목표 추가 함수
    function addObjective() {
        const objectiveList = document.querySelector('.objective-list');
        const objectiveItem = document.createElement('div');
        objectiveItem.classList.add('objective-item');
        objectiveItem.innerHTML = `
            <input type="hidden" class="objective-id" value="">
            <input type="text" class="objective-input box" placeholder="목표를 입력하세요">
            <input type="month" class="date-input box">
            <input type="checkbox" class="checkbox">
            <button class="delete-button button box" onclick="deleteObjective(this)">삭제</button>
        `;
        objectiveList.appendChild(objectiveItem);
    }

    // 목표 삭제 함수
    function deleteObjective(button) {
        const objectiveItem = button.parentElement;
        objectiveItem.remove();
    }

    // 목표 저장 함수
    function saveObjectives() {
        const objectives = [];
        document.querySelectorAll('.objective-item').forEach(item => {
            const id = item.querySelector('.objective-id').value;
            const content = item.querySelector('.objective-input').value;
            const date = item.querySelector('.date-input').value + "-01"; // 날짜 형식 수정
            const isCompleted = item.querySelector('.checkbox').checked;
            if (content.trim() && date) {
                objectives.push({ id: id || null, content, objectiveYearMonth: date, isCompleted });
            }
        });

        fetch('/mypage/objectives', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(objectives)
        }).then(response => {
            if (response.ok) {
                alert('목표가 저장되었습니다.');
                location.reload();
            } else {
                alert('목표 저장에 실패했습니다.');
            }
        });
    }


    // 취소 함수
    function cancelEdit() {
        location.reload();
    }
</script>
</body>
</html>
