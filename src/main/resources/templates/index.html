<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>타임리프 레이아웃</title>
    <link rel="stylesheet" th:href="@{/css/base.css}">
    <link rel="stylesheet" th:href="@{/css/reset.css}">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<header>
    <section class="header-top">
        <div class="logo" th:src="@{/images/logo.png}"></div>
        <input class="search-bar" placeholder="검색" type="text">
    </section>
    <nav>
        <div class="menu-item" th:each="menu : ${subMenus}">
            <a th:href="${menu.url}" th:text="${menu.title}"></a>
            <div class="submenu" th:if="${menu.items != null}">
                <a class="submenu-item"
                   th:each="item, stat : ${menu.items}"
                   th:text="${item}"
                   th:href="${menu.itemUrls[stat.index.intValue()]}">
                </a>
            </div>
        </div>
    </nav>
</header>

<main>
    <section class="main-contents">
        <div th:if="${mainFragment1 != null}">
            <div th:replace="${mainFragment1}"></div>
        </div>
        <div th:if="${mainFragment2 != null}">
            <div th:replace="${mainFragment2}"></div>
        </div>
        <div th:if="${mainFragment3 != null}">
            <div th:replace="${mainFragment3}"></div>
        </div>
        <div th:if="${mainFragmen4 != null}">
            <div th:replace="${mainFragment4}"></div>
        </div>
        <div th:if="${mainFragment5 != null}">
            <div th:replace="${mainFragment5}"></div>
        </div>
        <div th:if="${mainFragment6 != null}">
            <div th:replace="${mainFragment6}"></div>
        </div>
    </section>
    <section class="side-contents">
        <div th:if="${sideFragment1 != null}">
            <div th:replace="${sideFragment1}"></div>
        </div>
        <div th:if="${sideFragment2 != null}">
            <div th:replace="${sideFragment2}"></div>
        </div>
        <div th:if="${sideFragment3 != null}">
            <div th:replace="${sideFragment3}"></div>
        </div>
    </section>
</main>
<script th:inline="javascript">
    $.ajaxSetup({
        beforeSend: function (xhr) {
            xhr.setRequestHeader("X-Requested-With", "XMLHttpRequest");
        }
    });

    // 전역 AJAX 에러 핸들러
    $(document).ajaxError(function (event, jqXHR) {
        if (jqXHR.status === 403) {
            Swal.fire({
                title: '접근 제한',
                text: '접근 권한이 없습니다.',
                icon: 'error',
                confirmButtonText: '확인',
                confirmButtonColor: '#3085d6',
                width: '360px'
            });
        }
    });

    // 사용 예시: AJAX 요청
    function adminRequest() {
        $.ajax({
            url: '/admin/test',
            type: 'GET',
            success: function (response) {
                // 성공 시 처리
            }
            // 실패 시에는 위의 전역 에러 핸들러가 처리함
        });
    }

    // write-post
    function autoResize(textarea) {
        textarea.style.height = 'auto';
        if (textarea.scrollHeight <= 700) {
            textarea.style.height = Math.max(560, textarea.scrollHeight) + 'px';
            textarea.style.overflowY = 'hidden';
        } else {
            textarea.style.height = '700px';
            textarea.style.overflowY = 'scroll';
        }
    }

    function updatePost() {
        let postId = document.getElementById('post-id').value;
        let userId = document.getElementById('user-id').value;
        const postType = document.getElementById('post-type').value;

        const targetId = postType === 'PARTICIPATION_CATEGORY'
            ? document.getElementById('categories').value
            : postType === 'PARTICIPATION_REGION'
                ? document.getElementById('regions').value
                : null;

        $.ajax({
            url: `/api/post/${postId}`,
            type: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify({
                title: document.getElementById('title').value,
                content: document.getElementById('content').value,
                userId: userId,
                postType: postType,
                targetId: targetId
            }),
            success: function () {
                alert('수정이 완료되었습니다');

                let redirectUrl = '';
                if (postType === 'PARTICIPATION_CATEGORY') {
                    redirectUrl = `/category/post/${postId}?targetId=${targetId}`;
                } else if (postType === 'PARTICIPATION_REGION') {
                    redirectUrl = `/region/post/${postId}?targetId=${targetId}`;
                } else if (postType === 'PARTICIPATION_CHALLENGE') {
                    redirectUrl = `/challenge/post/${postId}`;
                } else if (postType === 'ANNOUNCEMENT') {
                    redirectUrl = `/announcement/post/${postId}`;
                } else if (postType === 'GENERATION_CHALLENGE') {
                    redirectUrl = `/announcement/post/${postId}`;
                } else {
                    redirectUrl = `/index`;
                }
                location.replace(redirectUrl);
            },
            error: function () {
                alert("수정에 실패했습니다.");
            }
        });
    }

    function createPost() {
        let userId = document.getElementById('user-id').value;
        const postType = document.getElementById('post-type').value;

        const targetId = postType === 'PARTICIPATION_CATEGORY'
            ? document.getElementById('categories').value
            : postType === 'PARTICIPATION_REGION'
                ? document.getElementById('regions').value
                : null;

        $.ajax({
            url: `/api/post/${userId}/create`,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                title: $('#title').val(),
                content: $('#content').val(),
                userId: userId,
                postType: postType,
                targetId: targetId
            }),
            success: function (data) {
                const postId = data.postId;
                alert('등록이 완료되었습니다.');

                let redirectUrl = '';
                if (postType === 'PARTICIPATION_CATEGORY') {
                    redirectUrl = `/category/post/${postId}?targetId=` + targetId;
                } else if (postType === 'PARTICIPATION_REGION') {
                    redirectUrl = `/region/post/${postId}?targetId=` + targetId;
                } else if (postType === 'PARTICIPATION_CHALLENGE') {
                    redirectUrl = `/challenge/post/${postId}`;
                } else if (postType === 'ANNOUNCEMENT') {
                    redirectUrl = `/announcement/post/${postId}`;
                } else if (postType === 'GENERATION_CHALLENGE') {
                    redirectUrl = `/announcement/post/${postId}`;
                } else {
                    redirectUrl = `/index`;
                }

                location.replace(redirectUrl);
            },
            error: function () {
                alert('등록에 실패했습니다.');
            }
        });
    }

    function cancelPost() {
        let postId = document.getElementById('post-id').value;
        const postType = document.getElementById('post-type').value;
        const targetId = postType === 'PARTICIPATION_CATEGORY'
            ? document.getElementById('categories').value
            : postType === 'PARTICIPATION_REGION'
                ? document.getElementById('regions').value
                : null;

        let redirectUrl = '';

        if (postId) {
            if (postType === 'PARTICIPATION_CATEGORY') {
                redirectUrl = `/category/post/${postId}?targetId=${targetId}`;
            } else if (postType === 'PARTICIPATION_REGION') {
                redirectUrl = `/region/post/${postId}?targetId=${targetId}`;
            } else if (postType === 'PARTICIPATION_CHALLENGE') {
                redirectUrl = `/challenge/post/${postId}`;
            } else if (postType === 'ANNOUNCEMENT') {
                redirectUrl = `/announcement/post/${postId}`;
            } else if (postType === 'GENERATION_CHALLENGE') {
                redirectUrl = `/announcement/post/${postId}`;
            } else {
                redirectUrl = `/index`;
            }
        } else {
            if (postType === 'PARTICIPATION_CATEGORY') {
                redirectUrl = `/category?id=${targetId}`;
            } else if (postType === 'PARTICIPATION_REGION') {
                redirectUrl = `/region?id=${targetId}`;
            } else if (postType === 'PARTICIPATION_CHALLENGE') {
                redirectUrl = `/challenge`;
            } else if (postType === 'ANNOUNCEMENT' || postType === 'GENERATION_CHALLENGE') {
                redirectUrl = `/announcement`;
            } else {
                redirectUrl = `/index`;
            }
        }

        location.replace(redirectUrl);
    }

    // view-post
    function adjustContainerHeight() {
        const postContent = document.querySelector('.post-content');
        const buttons = document.querySelector('.action-buttons');
        const minHeight = 700;

        if (postContent) {
            if (postContent.scrollHeight < minHeight) {
                buttons.style.marginTop = `${minHeight - postContent.scrollHeight + 20}px`;
            } else {
                buttons.style.marginTop = '20px';
            }
        }
    }

    adjustContainerHeight();

    function modifyPost() {
        const postId = document.getElementById("post-id").value;
        const postType = document.getElementById("post-type").value;
        const targetId = document.getElementById("target-id").value;

        if (postId && postType) {
            let locationPath = ``;

            if (postType === 'PARTICIPATION_CATEGORY' || postType === 'PARTICIPATION_REGION') {
                locationPath = `/write?postId=${postId}&postType=${postType}&targetId=${targetId}`;
            } else {
                locationPath = `/writeChallenge?postId=${postId}&postType=${postType}`;
            }

            location.href = locationPath;
        }
    }

    function deletePost() {
        let id = document.getElementById('post-id').value;
        const postType = document.getElementById("post-type").value;
        const targetId = document.getElementById("target-id").value;

        $.ajax({
            url: `/api/post/${id}`,
            type: 'DELETE',
            success: function () {
                alert('삭제가 완료되었습니다');

                let redirectPath = '/post/posts';
                switch (postType) {
                    case 'PARTICIPATION_CATEGORY':
                        redirectPath = `/category?id=${targetId}`;
                        break;
                    case 'PARTICIPATION_REGION':
                        redirectPath = `/region?id=${targetId}`;
                        break;
                    case 'PARTICIPATION_CHALLENGE':
                        redirectPath = `/challenge`;
                        break;
                    default:
                        redirectPath = `/announcement`;
                        break;
                }

                location.replace(redirectPath);
            },
            error: function () {
                console.error('삭제에 실패했습니다.');
            }
        });
    }

    function toggleLike() {
        const targetId = document.getElementById("post-id").value;
        const userId = document.getElementById("user-id").value;
        const likeButton = document.getElementById("like-button");
        const likeText = document.getElementById("like-text");
        const likeCountElement = document.getElementById("like-count");

        const isLiked = likeButton.textContent.includes("취소");
        const url = isLiked ? "/api/post/unlike" : "/api/post/like";

        likeButton.disabled = true;

        fetch(url, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({targetId, userId}),
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    likeText.textContent = isLiked ? "좋아요" : "좋아요 취소";
                    likeCountElement.textContent = data.likeCount.toString();
                }
            })
            .catch(error => console.error("Error:", error))
            .finally(() => {
                likeButton.disabled = false;
            });
    }

    // view-comment
    function replyToComment(commentId) {
        const commentContainer = document.querySelector(`.comment[data-comment-id='${commentId}'] .comments-container`);
        const commentWriteContainer = document.getElementById("comment-write-container");
        const commentEditContainer = document.getElementById("comment-edit-container");
        const cancelButton = document.getElementById("write-cancel-button");

        commentContainer.appendChild(commentWriteContainer);

        commentWriteContainer.style.display = "block";
        commentEditContainer.style.display = "none";
        cancelButton.style.display = "inline-block";
    }

    function handleSubmit() {
        const commentWriteContainer = document.getElementById("comment-write-container");
        const parentCommentElement = commentWriteContainer.previousElementSibling ? commentWriteContainer.previousElementSibling.closest(".comment") : null;
        const parentCommentId = parentCommentElement ? parentCommentElement.getAttribute("data-comment-id") : null;

        const isReply = parentCommentId !== null;
        const commentId = isReply ? parentCommentId : null;

        if (isReply) {
            submitReply(commentId);
        } else {
            submitComment();
        }
    }

    function submitReply(commentId) {
        let url = '/api/post/';
        let postId =  /*[[${postId}*/ '';


        url += postId + '/comment/' + commentId;

        const content = document.getElementById("write-comment-text-box").value;

        if (content.trim() !== '') {
            $.ajax({
                url: url,
                type: 'POST',
                data: JSON.stringify({parentCommentId: commentId, content: content}),
                contentType: 'application/json',
                success: function () {
                    document.querySelector(".comment-text-box").value = '';
                    location.reload();
                },
                error: function () {
                    alert("댓글을 추가하는 데 실패했습니다.");
                }
            });
        } else {
            alert("내용을 입력해 주세요.");
        }
    }

    function submitComment() {
        let url = '/api/post/';
        let postId = /*[[${postId}]]*/'';

        url += postId + '/comment';

        const content = document.getElementById("write-comment-text-box").value;

        if (content.trim() !== '') {
            $.ajax({
                url: url,
                type: 'POST',
                data: JSON.stringify({content: content}),
                contentType: 'application/json',
                success: function () {
                    document.querySelector(".comment-text-box").value = '';
                    location.reload();
                },
                error: function () {
                    alert("댓글을 추가하는 데 실패했습니다.");
                }
            });
        } else {
            alert("내용을 입력해 주세요.");
        }
    }

    function editComment(commentId) {
        const commentEditContainer = document.getElementById("comment-edit-container");
        const commentWriteContainer = document.getElementById("comment-write-container");
        const commentContainer = document.querySelector(`.child-comment[data-reply-id='${commentId}'] .comments-container`)
            ? document.querySelector(`.child-comment[data-reply-id='${commentId}'] .comments-container`)
            : document.querySelector(`.comment[data-comment-id='${commentId}'] .comments-container`);

        commentEditContainer.style.display = "block";
        commentWriteContainer.style.display = "none";

        commentContainer.appendChild(commentEditContainer);

        const commentElement = document.querySelector(`.child-comment[data-reply-id='${commentId}'] .comments-container .content`)
            ? document.querySelector(`.child-comment[data-reply-id='${commentId}'] .comments-container .content`)
            : document.querySelector(`.comment[data-comment-id='${commentId}'] .comments-container .content`);
        document.querySelector(".comment-text-box").value = commentElement.innerText;

        document.querySelector(".submit-button").setAttribute("onclick", "editCommentSubmit()");
    }

    function editCommentSubmit() {
        const commentEditContainer = document.getElementById("comment-edit-container");
        const commentElement = commentEditContainer.previousElementSibling.closest(".child-comment") ? commentEditContainer.previousElementSibling.closest(".child-comment") : commentEditContainer.previousElementSibling.closest(".comment");
        const commentId = commentElement.getAttribute("data-reply-id") ? commentElement.getAttribute("data-reply-id") : commentElement.getAttribute("data-comment-id");

        let url = '/api/post/comment/' + commentId;

        const content = document.getElementById("edit-comment-text-box").value;

        if (content.trim() !== '') {
            $.ajax({
                url: url,
                type: 'PUT',
                data: JSON.stringify({content: content}),
                contentType: 'application/json',
                success: function () {
                    document.querySelector(".comment-text-box").value = '';
                    location.reload();
                },
                error: function () {
                    alert("댓글을 추가하는 데 실패했습니다.");
                }
            });
        } else {
            alert("내용을 입력해 주세요.");
        }

    }

    function deleteComment(commentId) {
        if (confirm("댓글을 삭제하시겠습니까?")) {
            fetch(`/api/post/comment/${commentId}`, {
                method: "DELETE"
            }).then(response => {
                if (response.ok) {
                    location.reload();
                }
            });
        }
    }

    function cancelComment() {
        const commentWriteContainer = document.getElementById("comment-write-container");
        const commentEditContainer = document.getElementById("comment-edit-container");
        const cancelButton = document.getElementById("write-cancel-button");

        commentWriteContainer.style.display = "block";
        commentEditContainer.style.display = "none";
        cancelButton.style.display = "none";

        document.getElementById("view-comment").insertAdjacentElement("afterend", document.getElementById("comment-write-container"));
    }

    // TODO 댓글 작성창 크기 조절
    /*const textarea = document.querySelectorAll('.comment-text-box');
    const resizeHandle = document.querySelectorAll('.resize-handler');

    for (let i = 0; i < textarea.length; i++) {
        resizeHandle.item(i).addEventListener('mousedown', (e) => {
            e.preventDefault();

            function resize(e) {
                textarea.item(i).style.height = `${e.clientY - textarea.item(i).getBoundingClientRect().top}px`;
            }

            function stopResize() {
                window.removeEventListener('mousemove', resize);
                window.removeEventListener('mouseup', stopResize);
            }

            window.addEventListener('mousemove', resize);
            window.addEventListener('mouseup', stopResize);
        })
    }*/

    // bulletin-board-list
    function sortPosts(sortType) {
        const url = new URL(window.location.href);
        url.searchParams.set('sort', sortType);
        window.location.href = url.toString();
    }

    function changePageDirection(direction) {
        const currentPage = parseInt(new URLSearchParams(window.location.search).get('page')) || 1;
        const totalPages = [[${totalPages}]];
        let newPage = currentPage;

        if (direction === 'prev' && currentPage > 0) {
            newPage = currentPage - 1;
        } else if (direction === 'next' && currentPage < totalPages - 1) {
            newPage = currentPage + 1;
        }

        const url = new URL(window.location.href);
        url.searchParams.set('page', newPage);
        window.location.href = url.toString();
    }

    function changePage(page) {
        const urlParams = new URLSearchParams(window.location.search);
        urlParams.set('page', (page - 1).toString());
        window.location.search = urlParams.toString();
    }

    function searchUserPosts() {
        const searchType = document.querySelector('.admin-controls select').value;
        const searchQuery = document.querySelector('.admin-controls input[type="text"]').value;

        if (searchQuery.trim() === "") {
            alert("검색어를 입력하세요.");
            return;
        }

        const url = new URL(window.location.href);
        url.searchParams.set('searchType', searchType);
        url.searchParams.set('query', searchQuery);
        window.location.href = url.toString();
    }

    function goToWritePage() {
        // 글쓰기 페이지로 이동
        const postType = document.getElementById('post-type').value;
        const targetId = document.getElementById('target-id').value;
        if (postType === 'PARTICIPATION_CATEGORY' || postType === 'PARTICIPATION_REGION') {
            window.location.href = `/write?postType=${postType}&targetId=${targetId}`;
        } else {
            window.location.href = `/writeChallenge?postType=${postType}`;
        }
    }

    function searchAdminPosts() {
        const searchType = document.querySelector('select[name="searchType"]').value;
        const postType = document.querySelector('select[name="post_type"]').value;
        const targetId = document.querySelector('select[name="target_id"]').value;
        const isActive = document.querySelector('select[name="isActive"]').value;
        const searchQuery = document.querySelector('input[name="searchQuery"]').value;

        const url = new URL(window.location.href);
        url.searchParams.set("searchType", searchType);
        url.searchParams.set("postType", postType);
        url.searchParams.set("targetId", targetId);
        url.searchParams.set("isActive", isActive);
        url.searchParams.set("searchQuery", searchQuery);

        window.location.href = url.toString();
    }

    document.querySelectorAll('#post-link').forEach(function (link) {
        const postType = document.getElementById('post-type').value;
        const postId = link.getAttribute('data-postId');
        const targetId = document.getElementById('target-id').value;
        let url = '';

        switch (postType) {
            case 'PARTICIPATION_CATEGORY':
                url = `/category/post/${postId}?targetId=${targetId}`;
                break;
            case 'PARTICIPATION_REGION':
                url = `/region/post/${postId}?targetId=${targetId}`;
                break;
            case 'PARTICIPATION_CHALLENGE':
                url = `/challenge/post/${postId}`;
                break;
            case 'ANNOUNCEMENT':
                url = `/announcement/post/${postId}`;
                break;
            default:
                url = `/post/${postId}`;
                break;
        }

        link.setAttribute('href', url);
    });
</script>
</body>
</html>
